# name: Deploy App Smart Retail Management System

# on:
#   push:
#     branches: ["deployment"]

# jobs:
#   test:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Skip tests (temporary)
#         run: echo "Tests skipped - will be implemented later"

#   deploy:
#     runs-on: self-hosted
#     needs: test

#     steps:
#       - name: Pull latest code
#         run: |
#           cd /home/ubuntu/smart-retail-management-system
#           git fetch origin
#           git checkout deployment || git checkout -b deployment origin/deployment
#           git reset --hard origin/deployment

#       - name: Copy environment file
#         run: |
#           cd /home/ubuntu/smart-retail-management-system
#           cp .env.production.example .env.production

#       - name: Stop and remove containers
#         run: |
#           cd /home/ubuntu/smart-retail-management-system
#           sudo docker compose down

#       - name: Rebuild and restart with Docker Compose
#         run: |
#           cd /home/ubuntu/smart-retail-management-system
#           sudo docker compose up --build -d

name: ğŸ›ï¸ Deploy App Smart Retail Management System

on:
  push:
    branches: ["deployment"]
  pull_request:
    branches: ["deployment"]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â­ï¸ Skip tests (temporary)
        run: echo "ğŸ§ª Tests skipped - will be implemented later"

      # - name: ğŸŸ¢ Set up Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: 20

      # - name: ğŸ“¦ Install dependencies
      #   run: npm ci

      # - name: ğŸ§ª Run tests
      #   run: npm run test

  deploy:
    runs-on: self-hosted
    needs: test

    steps:
      - name: ğŸ”„ Pull latest code
        run: |
          echo "ğŸ“¡ Fetching latest code from repository..."
          cd /home/ubuntu/smart-retail-management-system
          git fetch origin
          git checkout deployment || git checkout -b deployment origin/deployment
          git reset --hard origin/deployment
          echo "âœ… Code updated successfully"

      - name: ğŸ“‹ Copy environment file
        run: |
          echo "ğŸ”§ Setting up environment configuration..."
          cd /home/ubuntu/smart-retail-management-system
          cp .env.production.example .env.production
          echo "âœ… Environment file configured"

      - name: ğŸ” Check database and Redis status
        id: check_services
        run: |
          echo "ğŸ” Checking database and Redis status..."
          cd /home/ubuntu/smart-retail-management-system

          # Check if db-postgres container is running and healthy
          DB_STATUS="down"
          if sudo docker ps --filter "name=db-postgres" --filter "status=running" --format "{{.Names}}" | grep -q "db-postgres"; then
            echo "ğŸ—„ï¸ Database container is running, checking connection..."
            if sudo docker exec db-postgres pg_isready -U tuanthanh -d smart_store >/dev/null 2>&1; then
              echo "âœ… Database is healthy"
              DB_STATUS="up"
            else
              echo "âš ï¸ Database container running but not accepting connections"
            fi
          else
            echo "âŒ Database container is not running"
          fi

          # Check if Redis container is running and healthy
          REDIS_STATUS="down"
          if sudo docker ps --filter "name=redis" --filter "status=running" --format "{{.Names}}" | grep -q "redis"; then
            echo "ğŸ”´ Redis container is running, checking connection..."
            if sudo docker exec redis redis-cli -a abc123xyz ping >/dev/null 2>&1; then
              echo "âœ… Redis is healthy"
              REDIS_STATUS="up"
            else
              echo "âš ï¸ Redis container running but not accepting connections"
            fi
          else
            echo "âŒ Redis container is not running"
          fi

          echo "db_status=$DB_STATUS" >> $GITHUB_OUTPUT
          echo "redis_status=$REDIS_STATUS" >> $GITHUB_OUTPUT

      - name: ğŸ›‘ Stop application containers only
        run: |
          echo "ğŸ”„ Stopping application containers (keeping database and Redis if healthy)..."
          cd /home/ubuntu/smart-retail-management-system

          # Stop only application containers
          if sudo docker ps --filter "name=api-system" --format "{{.Names}}" | grep -q "api-system"; then
            echo "ğŸ›‘ Stopping api-system..."
            sudo docker stop api-system
            sudo docker rm api-system
          fi

          if sudo docker ps --filter "name=console" --format "{{.Names}}" | grep -q "console"; then
            echo "ğŸ›‘ Stopping console..."
            sudo docker stop console
            sudo docker rm console
          fi

          echo "âœ… Application containers stopped"

      - name: ğŸ›‘ Stop and recreate database if unhealthy
        if: steps.check_services.outputs.db_status == 'down'
        run: |
          echo "ğŸ”„ Database is unhealthy, stopping and will recreate..."
          cd /home/ubuntu/smart-retail-management-system

          if sudo docker ps -a --filter "name=db-postgres" --format "{{.Names}}" | grep -q "db-postgres"; then
            sudo docker stop db-postgres || true
            sudo docker rm db-postgres || true
          fi

          echo "âœ… Database container removed"

      - name: ğŸ›‘ Stop and recreate Redis if unhealthy
        if: steps.check_services.outputs.redis_status == 'down'
        run: |
          echo "ğŸ”„ Redis is unhealthy, stopping and will recreate..."
          cd /home/ubuntu/smart-retail-management-system

          if sudo docker ps -a --filter "name=redis" --format "{{.Names}}" | grep -q "redis"; then
            sudo docker stop redis || true
            sudo docker rm redis || true
          fi

          echo "âœ… Redis container removed"

      - name: ğŸ—‘ï¸ Clean up unused Docker resources
        run: |
          echo "ğŸ§¹ Cleaning up unused Docker resources..."
          sudo docker image prune -f
          sudo docker container prune -f
          sudo docker network prune -f
          echo "âœ… Docker cleanup completed"

      - name: ğŸ”¨ Start database if needed
        if: steps.check_services.outputs.db_status == 'down'
        run: |
          echo "ğŸ—ï¸ Starting database container..."
          cd /home/ubuntu/smart-retail-management-system
          sudo docker compose up -d db-postgres

          echo "â³ Waiting for database to be ready..."
          timeout=60
          while [ $timeout -gt 0 ]; do
            if sudo docker exec db-postgres pg_isready -U tuanthanh -d smart_store >/dev/null 2>&1; then
              echo "âœ… Database is ready"
              break
            fi
            echo "â³ Waiting for database... ($timeout seconds left)"
            sleep 2
            timeout=$((timeout-2))
          done

          if [ $timeout -le 0 ]; then
            echo "âŒ Database failed to start within timeout"
            exit 1
          fi

      - name: ğŸ”¨ Start Redis if needed
        if: steps.check_services.outputs.redis_status == 'down'
        run: |
          echo "ğŸ—ï¸ Starting Redis container..."
          cd /home/ubuntu/smart-retail-management-system
          sudo docker compose up -d redis

          echo "â³ Waiting for Redis to be ready..."
          timeout=30
          while [ $timeout -gt 0 ]; do
            if sudo docker exec redis redis-cli -a abc123xyz ping >/dev/null 2>&1; then
              echo "âœ… Redis is ready"
              break
            fi
            echo "â³ Waiting for Redis... ($timeout seconds left)"
            sleep 2
            timeout=$((timeout-2))
          done

          if [ $timeout -le 0 ]; then
            echo "âŒ Redis failed to start within timeout"
            exit 1
          fi

      - name: ğŸ”¨ Build and start application containers
        run: |
          echo "ğŸ—ï¸ Building and starting application containers..."
          cd /home/ubuntu/smart-retail-management-system

          # Build and start api-system (always rebuild)
          sudo docker compose up --build -d api-system

          # Build and start console (always rebuild)
          sudo docker compose up --build -d console

          echo "âœ… Application containers started successfully"

      - name: â³ Wait for services to be ready
        run: |
          echo "â³ Waiting for services to start..."
          sleep 30

          # Check if all containers are running
          cd /home/ubuntu/smart-retail-management-system
          if ! sudo docker compose ps | grep -E "(api-system|console|db-postgres|redis)" | grep -q "Up"; then
            echo "âŒ Some services failed to start"
            sudo docker compose logs
            exit 1
          fi
          echo "âœ… All services are up and running"

      - name: ğŸ¥ Health check
        run: |
          echo "ğŸ” Performing health checks..."

          # Check API health (adjust URL as needed)
          if curl -f http://localhost:3000/health 2>/dev/null; then
            echo "âœ… API System is healthy"
          else
            echo "âš ï¸  API health check failed or endpoint not available"
          fi

          # Check Store Interface (adjust URL as needed)
          if curl -f http://localhost:3268 2>/dev/null; then
            echo "âœ… Store Interface is accessible"
          else
            echo "âš ï¸  Store Interface health check failed"
          fi

          # Check Database
          cd /home/ubuntu/smart-retail-management-system
          if sudo docker exec db-postgres pg_isready -U tuanthanh -d smart_store >/dev/null 2>&1; then
            echo "âœ… Database is healthy"
          else
            echo "âŒ Database health check failed"
          fi

          # Check Redis
          if sudo docker exec redis redis-cli -a abc123xyz ping >/dev/null 2>&1; then
            echo "âœ… Redis is healthy"
          else
            echo "âŒ Redis health check failed"
          fi

      - name: ğŸ“Š Show running containers
        run: |
          cd /home/ubuntu/smart-retail-management-system
          echo "ğŸ“‹ Currently running containers:"
          sudo docker compose ps

      - name: ğŸ‰ Deployment notification
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo ""
          echo "ğŸŒ Services available at:"
          echo "  ğŸ”Œ API System: http://localhost:3000"
          echo "  ğŸ›ï¸ Store Interface: http://localhost:3268"
          echo "  ğŸ—„ï¸ Database: localhost:5432"
          echo "  ğŸ”´ Redis: localhost:6379"
          echo ""
          echo "âœ¨ Smart Retail Management System is now live!"
          echo ""
          echo "ğŸ“Š Service status:"
          echo "  ğŸ—„ï¸ Database: ${{ steps.check_services.outputs.db_status == 'up' && 'Reused existing' || 'Recreated' }}"
          echo "  ğŸ”´ Redis: ${{ steps.check_services.outputs.redis_status == 'up' && 'Reused existing' || 'Recreated' }}"
          echo "  ğŸ”Œ API System: Rebuilt"
          echo "  ğŸ›ï¸ Store Interface: Rebuilt"
